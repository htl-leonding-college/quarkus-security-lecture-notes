// https://fontawesome.com/v4.7.0/icons/
icon:file-text-o[link=https://github.com/htl-leonding-college/quarkus-security-lecture-notes/blob/master/asciidocs/{docname}.adoc] ‏ ‏ ‎
icon:github-square[link=https://github.com/htl-leonding-college/quarkus-security-lecture-notes] ‏ ‏ ‎
icon:home[link=https://htl-leonding.github.io/]



----
Credits for Halil Bahar for his awesome quarkus-angular-keycloak lecture
----

== Concept

.source: https://medium.com/swlh/angular-quarkus-keycloak-security-ac95d4547d1[Catalin Patrut - Angular, Quarkus, Keycloak, Security, window="_blank"]
image:0-security-concept.png[]

== Create Quarkus Project

[source,shell]
----
mkdir keycloak-demo
cd keycloak-demo
----

.Create a simple maven project: menu:File[New > Project... > Maven]
[%collapsible]
//[%collapsible%open]
====
image:a-create-quarkus-project-01.png[]

image:a-create-quarkus-project-02.png[]

====

.Create a new module: menu:File[New > Module... > Quarkus]
[%collapsible]
//[%collapsible%open]
====
image:a-create-quarkus-project-03.png[]

image:a-create-quarkus-project-04.png[]

image:a-create-quarkus-project-05.png[]

====

.Make changes in the endpoint
[source,java]
----
@Path("/hello")
public class ExampleResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello from Server";
    }
}
----

.Start the Quarkus app - Open a terminal in IntelliJ
[source,shell]
----
cd quarkus-backend
./mvnw clean compile quarkus:dev
----

== Access to the Unprotected Endpoint

=== Create a http-client in IntelliJ

* Right Click on project root `quarkus-angular-keycloak-demo`
* menu:New[HTTP Request]
* Name: `http-request/request.http`
* Write http-request

.request.http
[source,http]
----
GET http://localhost:8080/hello

###
----

=== Disable openid connect (oidc)

.src/main/resources/application.properties
[source,properties]
----
# OIDC Configuration
quarkus.oidc.enabled=false
----

[IMPORTANT]
====
When oidc is not disabled, the following error will occur:

----
io.quarkus.oidc.OIDCException: Tenant configuration has not been resolved
----
====

== Use the http-client

image:b-create-http-client.png[]




== Configure Keycloak

=== Run Keycloak-Docker-Container

[source,shell script]
----
docker run --rm -p 8180:8080 -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin jboss/keycloak:15.0.2
----

=== Access Administration Console

* http://localhost:8180
* Administration Console
* admin / admin

image:c-keycloak-add-realm.png[]

=== Add Realm

* Add realm
** Name: *htl*
** kbd:[Create]

=== Add Client


* Clients
** kbd:[Create]
*** ClientID: *demo*
*** Client Protocol: *openid-connect*
*** Advanced Settings
**** Access Token Lifespan: *???*
**** Client Session Idle: *???*
*** Click kbd:[Save]

* Users
** kbd:[Add user]
*** Details
**** Username: admin
**** Email Verified: ON
**** kbd:[Save]

.Add user
[%collapsible]
====
image:c-keycloak-add-user.png[]
====
*** Credentials
**** Password: passme
**** Password Confirmation: passme
**** Temporary: OFF
**** kbd:[Set Password]
**** Are you sure you want to set a password for the user?: kbd:[Set password]

////
Now make a User "user" like "admin".
////

* Clients -> *demo*
** Settings
*** Access Type: bearer-only
*** Service Accounts Enabled: ON
*** Authorization Enabled: OFF
*** Valid Redirect URIs: http://localhost:8080/
*** kbd:[Save]
** Credentials
*** Copy Secret into clipboard
*** Paste the secret in application.properties in the line "quarkus.oidc.credentials.secret"

[TIP]
====
Bearer tokens allow requests to authenticate using an access key, such as a JSON Web Token (JWT). The token is a text string, included in the request header.

Bearer authentication (also called token authentication) is an HTTP authentication scheme that involves security tokens called bearer tokens. The name “Bearer authentication” can be understood as “give access to the bearer of this token.” The bearer token is a cryptic string, usually generated by the server in response to a login request. The client must send this token in the Authorization header when making requests to protected resources
====

== Create Angular App

























== Sources

* https://quarkus.io/guides/security-keycloak-authorization
* https://manfredsteyer.github.io/angular-oauth2-oidc/docs/
* https://youtu.be/5eR2uMMnJN4[YouTube: Microprofile Rest Client with TLS Authentication | Quarkus Tutorial | QUARKUS | TLS, window="_blank"]
* https://medium.com/swlh/angular-quarkus-keycloak-security-ac95d4547d1[Catalin Patrut - Angular, Quarkus, Keycloak, Security, window="_blank"]
* https://dev.to/anthonyikeda/securing-angular-and-quarkus-with-keycloak-pt-1-4g33[Anthony Ikeda - Securing Angular and Quarkus with Keycloak Pt 1, window="_blank"]
* https://www.keycloak.org/docs/latest/server_admin/#oidc-clients
* https://dev.to/anthonyikeda/securing-angular-and-quarkus-with-keycloak-pt-1-4g33
* https://dev.to/anthonyikeda/securing-angular-and-quarkus-with-keycloak-pt-2-43bh
* https://github.com/ErikMayrhofer/angular-quarkus-keycloak-example
** mit auth interceptor










































////


== Authorization with Policies

see also https://quarkus.io/guides/security-keycloak-authorization[Quarkus - Using OpenID Connect and Keycloak to Centralize Authorizations]

== Create your Quarkus Project

----
mvn io.quarkus:quarkus-maven-plugin:1.5.0.Final:create \
  -DprojectGroupId=at.htl \
  -DprojectArtifactId=quarkus-openid-connect \
  -Dextensions="oidc, resteasy-jsonb"
----

== Add the Endpoint (Resource)

.UserResource.java
[source,java]
----
include::{sourcedir-code}/UserResource.java[]
----

== Application configuration

.application.properties
[source,properties,options="nowrap"]
----
include::{sourcedir-code}/../../../resources/application.properties[]
----

== Make the Initial Commit

[source,shell]
----
cd openid-connect-policies

git init
git add .
git commit -m "inital commit"
git remote add origin https://github.com/<your github-account>/openid-connect-policies.git
git push -u origin master

idea .
----

== Add a extension

[source,shell]
----
./mvnw quarkus:add-extension -Dextensions="keycloak-authorization"
----

== Start Keycloak

[source,shell]
----
docker run --name keycloak -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin -e DB_VENDOR=h2 -p 8180:8080 jboss/keycloak
----

Open in Browser:
http://localhost:8180

== Configure Keycloak

-> Administration Console

* Add realm
** Name: quarkus
** kbd:[Create]
* Clients
** kbd:[Create]
*** ClientID: my-backend-service
*** Client Protocol: openid-connect
*** Click kbd:[Save]
* Users
** kbd:[Add user]
*** Details
**** Username: admin
**** Email Verified: ON
**** kbd:[Save]
*** Credentials
**** Password: passme
**** Password Confirmation: passme
**** Temporary: OFF
**** kbd:[Set Password]
**** Are you sure you want to set a password for the user?: kbd:[Set password]

Now make a User "user" like "admin".

* Clients -> my-backend-service
** Settings
*** Access Type: confidential
*** Service Accounts Enabled: ON
*** Authorization Enabled: OFF
*** Valid Redirect URIs: http://localhost:8080/
*** kbd:[Save]
** Credentials
*** Copy Secret into clipboard
*** Paste the secret in application.properties in the line "quarkus.oidc.credentials.secret"

== Access Keycloak

Now we will access Keycloak for the first time and retrieve the access token.

. Create a folder called `http-request` in the project root.
. Create a file called `requests.http` (the http-ending is important)
. Open the file `requests.http` and click on `Add Environmental File` -> Option `Regular`

Now a file called `http-client.env.json` was created:

We define some variables:

.http-client.env.json
----
{
  "dev": {
    "keycloak-host": "http://localhost:8180",
    "quarkus-host": "http://localhost:8080",
    "username": "my-backend-service",
    "password": "97fdb5b3-6fff-4090-966a-0f1c7355d0ba" // <.>
  }
}
----

<.> use your secret

.requests.http
----
POST {{keycloak-host}}/auth/realms/quarkus/protocol/openid-connect/token
Authorization: Basic {{username}} {{password}}
Content-Type: application/x-www-form-urlencoded

username=user&password=passme&grant_type=password
----

The output shows status code 201 and the access token.

== Configure Resources

* Clients -> my-backend-service
** Authorization
*** Resources
**** Actions - Delete the Default Resource -> Confirm the deletion
**** kbd:[Create]
**** Add Resource
***** Name: Users resource
***** Display name: Users resource
***** URI: /api/users/*
***** kbd:[Save]
**** kbd:[Create]
**** Add Resource
***** Name: Admin resource
***** Display name: Admin resource
***** URI: /api/admin/*
***** kbd:[Save]

image:clients-authorization-resources.png[]

* Roles
** kbd:[Add Role]
*** Role Name: user
*** kbd:[Save]
** kbd:[Add Role]
*** Role Name: admin
*** kbd:[Save]

* Users
** kbd:[View all users]
** Click on ID of user 'user'
*** Role Mappings
**** add Role 'user' to Assigned Roles
** Click on ID of user 'admin'
*** Role Mappings
**** add Roles 'user' and `admin` to Assigned Roles

* Clients -> my-backend-service
** Authorization
*** Policies
**** Create Policy ... -> Role
***** Name: Users policy
***** Description: Ability to use users resources
***** Realm Roles: user
***** kbd:[Save]
**** Create Policy ... -> Role
***** Name: Admin policy
***** Description: Ability to use admins resources
***** Realm Roles: admin
***** kbd:[Save]

*** Permissions
**** Default Permission -> kbd:[Delete] -> Confirm Deletion
**** Create Permission... -> Resource-Based
***** Name: Users permission
***** Resources: Users resource
***** Apply Policy: Users policy
***** kbd:[Save]
**** Create Permission... -> Resource-Based
***** Name: Admins permission
***** Resources: Admins resource
***** Apply Policy: Admins policy
***** kbd:[Save]

image:clients-authorization-permissions.png[]

== Test the Access to the Resources

=== Resource admin is unauthorized (w/o any authorization)

.Request with variable
----
GET {{quarkus-host}}/api/admin
----

.Request + Response
----
GET http://localhost:8080/api/admin

HTTP/1.1 401 Unauthorized
content-length: 0

<Response body is empty>

Response code: 401 (Unauthorized); Time: 644ms; Content length: 0 bytes
----

=== Resource users is unauthorized (w/o any authorization)

.Request with variable
----
GET {{quarkus-host}}/api/users
----

.Request + Response
----
GET http://localhost:8080/api/users

HTTP/1.1 401 Unauthorized
content-length: 0

<Response body is empty>

Response code: 401 (Unauthorized); Time: 54ms; Content length: 0 bytes
----





=== User 'user' access Resource 'users'

==== Retrieves access token

----
POST {{keycloak-host}}/auth/realms/quarkus/protocol/openid-connect/token
Authorization: Basic {{username}} {{password}}   # <.>
Content-Type: application/x-www-form-urlencoded

username=user&password=passme&grant_type=password

> {% client.global.set("auth_token", response.body.access_token); %}  # <.>
----

<.> you have to provide: `Authorization: Basic {client-id} {secret}`
<.> the access-token is saved in a variable `auth_token`, so the next request can use it

==== Accesses the users-Resource - 200

----
GET {{quarkus-host}}/api/users
Authorization: Bearer {{auth_token}}
----

==== Accesses the admin-Resource - 403

.Request with variable
----
GET {{quarkus-host}}/api/admin
Authorization: Bearer {{auth_token}}
----

.Request + Response
----
GET http://localhost:8080/api/admin

HTTP/1.1 403 Forbidden
content-length: 0

<Response body is empty>
----






=== User 'admin' access Resource 'users'

==== Retrieves access token

----
POST {{keycloak-host}}/auth/realms/quarkus/protocol/openid-connect/token
Authorization: Basic {{username}} {{password}}  # <.>
Content-Type: application/x-www-form-urlencoded

username=admin&password=passme&grant_type=password  # <.>

> {% client.global.set("auth_token", response.body.access_token); %}
----

<.> you have to provide: `Authorization: Basic {client-id} {secret}`
<.> the access-token is saved in a variable `auth_token`, so the next request can use it

==== Accesses the users-Resource - 200

----
GET {{quarkus-host}}/api/users
Authorization: Bearer {{auth_token}}
----

==== Accesses the admin-Resource - 200

.Request with variable
----
GET {{quarkus-host}}/api/admin
Authorization: Bearer {{auth_token}}
----

.Request + Response
----
GET http://localhost:8080/api/admin

HTTP/1.1 200 OK
Cache-Control: no-cache
Content-Length: 10
Content-Type: application/json

I am admin
----


////

